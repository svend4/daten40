# NEXT-18 — Evidence Retention & WORM Logs (SPEC)

**Дата:** 2026-01-13  
**Статус:** draft

## 0) Резюме
- **Problem:** Доказательства комплаенса и аудит-логи должны храниться неизменяемо, с понятными сроками ретеншна, legal hold и возможностью собрать “снимок на дату”.
- **Users:** Compliance admin, Security, Auditor (read-only), Legal.
- **Non-goals:** Сбор доказательств, построение отчётов, управление доступом аудиторов.
- **Success metrics:** 99.9% append success; доказуемая целостность цепочки; экспорт snapshot < N минут; отсутствие “удаления под hold”.

## 1) Термины
- **Evidence** — артефакт/лог, подтверждающий факт контроля.
- **WORM** — write once, read many (неизменяемость).
- **Retention** — правила хранения и удаления по сроку.
- **Legal hold** — запрет удаления по юридическим причинам.
- **Snapshot** — набор ссылок на evidence в период/на дату.

## 2) Архитектура (логическая)
Компоненты:
1) **Retention Policy Service** — хранит правила ретеншна и области применения.
2) **Legal Hold Service** — управляет hold, проверяет операции удаления.
3) **WORM Log Writer** — append-only журнал событий (EvidenceEvent).
4) **WORM Sink Adapter** — интерфейс адаптера к конкретному WORM-хранилищу.
5) **Snapshot Builder** — собирает “срез” по запросу, формирует manifest.

Границы:
- Этот блок хранит метаданные и неизменяемые записи.
- Большие бинарные объекты evidence — в object storage, журнал хранит ссылки + хеши.

## 3) Модель данных (v1)
### EvidenceArtifact
- `artifact_id` (uuid)
- `workspace_id`
- `type` (enum: access_log, config_export, report_pdf, …)
- `uri` (ссылка на объект)
- `sha256` (контент-хеш)
- `created_at`
- `tags` (map)

### EvidenceEvent (append-only)
- `event_id`
- `workspace_id`
- `event_type` (artifact_added, policy_changed, hold_created, snapshot_created, …)
- `payload_ref` (ссылка на payload, если большой)
- `prev_digest` (hash-chain)
- `digest` (sha256(prev_digest + canonical_event))
- `created_at`
- `actor` (subject)

### RetentionPolicy
- `policy_id`
- `workspace_id|global`
- `applies_to` (artifact types/tags)
- `min_retention_days`
- `delete_allowed` (bool) — часто false для compliance
- `effective_from`
- `version`

### LegalHold
- `hold_id`
- `workspace_id`
- `scope` (all | types | tags | ids)
- `reason`
- `created_at`
- `expires_at` (optional)
- `created_by`

## 4) Интерфейсы (контракты)
### WORM Sink Adapter (псевдо-интерфейс)
- `append(record_bytes) -> {"offset": "...", "digest": "..."}`
- `read(offset|range) -> records`
- `prove(offset) -> proof` (опционально, для attestations)

### Snapshot Builder
- `build_snapshot(workspace_id, from, to, filter) -> snapshot_id`
- `export_snapshot(snapshot_id) -> bundle_manifest_uri`

## 5) Политики
- Любая попытка удаления evidence проверяется на:
  - active legal hold
  - минимальный срок ретеншна
  - права роли (RBAC)
- Изменение policy/hold всегда фиксируется EvidenceEvent.

## 6) Потоки (flows)
### Flow A: Добавление evidence
1) Collector/ReportBuilder сохраняет binary в storage
2) Пишет EvidenceArtifact + EvidenceEvent(artifact_added) в WORM log
3) Возвращает artifact_id

### Flow B: Создание legal hold
1) Compliance admin создаёт hold
2) Сервис проверяет права
3) Пишет LegalHold + EvidenceEvent(hold_created)

### Flow C: Snapshot + экспорт
1) Auditor/Compliance запрашивает snapshot периода
2) Builder вычисляет набор EvidenceArtifact
3) Создаёт Snapshot record + EvidenceEvent(snapshot_created)
4) Формирует manifest (json) + (опционально) ZIP локально

## 7) Ошибки и повторные попытки
- Append идемпотентен по `event_id`
- Retry с backoff; при постоянной ошибке — DLQ/queue
- Если storage uri недоступна — snapshot помечается partial + причина

## 8) Observability
- Метрики: `worm_append_latency_ms`, `worm_append_errors_total`, `hold_blocked_deletes_total`, `snapshot_build_time_ms`
- Логи: structured, correlation_id = request_id
- Трейсинг: span per append/build/export

## 9) Тестирование
- Unit: hash-chain canonicalization
- Integration: adapter contract tests
- Security: попытки изменения/удаления, проверка RBAC
- Load: append QPS, snapshot build time

## 10) Риски
- vendor lock-in WORM storage
- стоимость хранения
- корректность canonicalization (иначе digest drift)

## 11) План внедрения
- v1: лог + политики + hold + snapshot manifest
- v2: реальные WORM adapters + attestations/signing
- v3: интеграция с auditor portal (NEXT-17) и dashboards
