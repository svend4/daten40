# NEXT-22 — Exceptions, Waivers & Risk Acceptance (SPEC)

**Дата:** 2026-01-13  
**Статус:** draft

## 0) Резюме
- **Problem:** Политики и гейты блокируют изменения, но бизнес иногда требует отклонения. Без формального механизма исключений возникает “теневой обход” без контроля и следов.
- **Users:** Compliance, Security, SRE/DevOps, Owners/Leads, Auditors (read-only отчёты).
- **Non-goals:** Замена policy engine, управление релизами, расчёт риска.
- **Success metrics:** 100% overrides имеют owner+reason+expiry; 0 “вечных” waiver; p95 время выдачи исключения < SLA; возможность аудита “кто/когда/почему”.

## 1) Термины
- **Exception** — постоянное или долгосрочное исключение (редко; требует строгих условий).
- **Waiver** — временное разрешение (обычно 24–72 часа/недели) с expiry.
- **Risk acceptance** — формальное принятие риска ответственным лицом.
- **Compensating control** — мера, компенсирующая отключённый/невыполненный контроль.
- **Override** — применённое переопределение правила в gate engine.

## 2) Архитектура (логическая)
Компоненты:
1) **Exception Intake** — принимает запрос (из UI, CI/CD, ticket).
2) **Approval Orchestrator** — маршрутизирует согласование (RACI/roles).
3) **Exception Registry** — хранит активные/истёкшие исключения и их scope.
4) **Override Publisher** — выдаёт “override hints” для NEXT-21 (policy override contract).
5) **Monitoring & Expiry** — следит за expiry, ревалидацией, авто-отзывом.
6) **Audit Writer** — пишет неизменяемые записи (worm_ref) и связывает с timeline.

## 3) Модель данных (v1)

### ExceptionRequest
- `request_id` (uuid)
- `workspace_id`
- `requested_by` (actor)
- `requested_at`
- `kind` (waiver|exception|risk_acceptance)
- `scope` (см. Scope)
- `gate_context_ref` (request_id/decision_id from NEXT-21)
- `risk_ref` (assessment_id from NEXT-20)
- `reason` (text)
- `proposed_controls` (list of CompensatingControl)
- `desired_expiry_at`
- `status` (pending|approved|rejected|withdrawn)

### Scope (canonical)
- `env` (prod|stage|dev)
- `resource` (repo/commit, service_id, connector_id, control_id, domain)
- `constraints` (time window, region, tenant, tags)

### ExceptionGrant
- `grant_id`
- `request_id`
- `approved_by` (list of approvers)
- `approved_at`
- `effective_from`
- `expires_at`
- `override_contract` (см. ниже)
- `required_controls` (list of CompensatingControl with status)
- `revoked_at` (optional)
- `revoked_by` (optional)
- `audit_ref` (worm_ref)

### CompensatingControl
- `control_id` (catalog id)
- `type` (manual_review|canary|extra_tests|monitoring|snapshot_before|freeze_window)
- `params` (map)
- `owner_role`
- `evidence_required` (bool)
- `evidence_ref` (optional)
- `status` (pending|satisfied|failed)

## 4) Контракт переопределения (Override Contract v1)
Цель — безопасно сообщить NEXT-21, что **конкретное правило** может быть ослаблено **в пределах scope** и **до expiry**, только при выполнении required_controls.

Минимальная форма (json):
- `grant_id`
- `applies_to` (scope)
- `overrides` (list of {policy_code, rule_id, allowed_decision, conditions})
- `expires_at`
- `required_controls` (ids + status links)
- `digest` (sha256 canonical contract)

## 5) Потоки (flows)

### Flow A: Request → Approval → Grant
1) Gate блокирует изменение (BLOCK) и выдаёт decision_id.
2) Пользователь создаёт ExceptionRequest с ссылкой на decision_id + risk_ref.
3) Approval Orchestrator выбирает цепочку согласования (RACI, criticality, domain).
4) При approval создаётся ExceptionGrant, публикуется override_contract.
5) NEXT-21 при следующей проверке учитывает override_contract и меняет решение на allow_with_controls (или allow).

### Flow B: Выполнение компенсирующих мер
1) Required_controls создают задачи (ticket, checklist, pipeline steps).
2) По мере выполнения прикрепляются evidence_refs (snapshot, тест-отчёты).
3) Если контроль не выполнен → override не активируется или становится invalid.

### Flow C: Expiry/Revocation
1) Monitoring проверяет `expires_at`.
2) По истечении — auto-revoke, запись в audit + уведомления.
3) Для продления требуется новый request/approval (no silent extension).

## 6) Политики и ограничения
- Waiver всегда имеет `expires_at` (обязательное поле).
- Для prod и high risk требуется минимум 2 approvers (security+owner) (пример).
- Нельзя override “non-overridable” controls (например, critical legal requirements) — политика.
- Максимальная длительность waiver зависит от домена/региона (policy pack).

## 7) Интеграции
- Ticketing: создать/обновить тикет на approval и required_controls.
- Notifications: напоминания за 7/3/1 день, эскалации.
- CI/CD: gate может требовать “approval token” (grant_id) как input.
- Auditor portal: экспорт списка waiver за период.

## 8) Ошибки и деградация
- Если недоступен Registry → gate не должен автоматически разрешать (fail-closed для prod).
- Если нет risk_ref → allow_with_controls + manual review (по policy).
- Все ошибки логируются и попадают в timeline.

## 9) Observability
- `exception_requests_total`, `exception_grants_active`, `waivers_expired_total`
- `overrides_applied_total`, `controls_failed_total`, `approval_time_ms`

## 10) Тестирование
- policy tests: non-overridable rules нельзя обойти
- replay: одинаковый grant -> одинаковый override_contract digest
- security: попытки расширить scope/expiry без approval

## 11) План внедрения
- v1: registry + approvals + overrides for NEXT-21
- v2: compensating controls catalog + evidence hooks
- v3: аналитика “почему часто просят waiver” + рекомендации по устранению первопричин
