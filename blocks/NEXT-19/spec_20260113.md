# NEXT-19 — Compliance Timeline & Snapshots (SPEC)

**Дата:** 2026-01-13  
**Статус:** draft

## 0) Резюме
- **Problem:** Аудит и внутренний контроль требуют ответов “на дату X” и сравнения периодов. Без временной модели комплаенса невозможно доказуемо показать динамику.
- **Users:** Compliance admin, Auditor, Security/IT, Leadership (read-only).
- **Non-goals:** Сбор evidence, WORM-хранилище, управление доступом аудиторов.
- **Success metrics:** Snapshot build p95 < 60s (на MVP объёмах); diff вычисляется < 10s; 0 критических расхождений digest; трассируемость “почему изменилось”.

## 1) Термины
- **Timeline** — упорядоченная лента нормализованных событий комплаенса.
- **Snapshot** — материализованный “срез” состояния на момент времени/интервал.
- **Projection** — индекс/представление для быстрых запросов (read-optimized).
- **Diff** — сравнение двух снимков: добавлено/удалено/изменено.
- **Reason** — объяснение, какие события/доказательства вызвали изменение.

## 2) Архитектура (логическая)
Компоненты:
1) **Event Normalizer** — приводит разные события (policy, configs, evidence, incidents) к TimelineEvent.
2) **Timeline Store** — хранит timeline событий (может быть поверх WORM-ссылок + индексы).
3) **Projection Builder** — строит материализованные представления (per control, per workspace, per domain).
4) **Snapshot Builder** — вычисляет snapshot по заданному времени/фильтру.
5) **Diff Engine** — сравнивает snapshots и генерирует explainable diff.
6) **Export Adapter** — формирует manifest/bundle для auditor portal.

## 3) Модель данных (v1)

### TimelineEvent
- `event_id` (uuid)
- `workspace_id`
- `timestamp`
- `source` (policy|iam|connector|evidence|incident|release|manual)
- `entity_type` (control|policy|asset|integration|report|evidence)
- `entity_id`
- `event_type` (changed|created|deleted|evaluated|attested)
- `severity` (info|warn|error)
- `summary`
- `details_ref` (uri to payload)
- `worm_ref` (link to NEXT-18 EvidenceEvent offset/digest) (optional but recommended)

### Snapshot
- `snapshot_id`
- `workspace_id`
- `as_of` (timestamp) OR `from`/`to`
- `filters` (tags/domains/controls)
- `digest` (sha256 of canonical snapshot content)
- `signed_digest_ref` (optional)
- `stats` (counts: controls_green/red, missing_evidence, partial)
- `items_ref` (uri to snapshot items, potentially chunked)

### SnapshotItem (canonical)
- `control_id`
- `status` (green|yellow|red|unknown)
- `evidence_refs` (list of artifact ids/uris)
- `last_changed_at`
- `reasons` (list of reason codes)
- `notes`

### SnapshotDiff
- `diff_id`
- `snapshot_a_id`
- `snapshot_b_id`
- `digest` (sha256 of canonical diff)
- `changes_ref` (uri)

## 4) Интерфейсы (контракты)

### Snapshot Builder API (псевдо)
- `build_snapshot(workspace_id, as_of|range, filters) -> snapshot_id`
- `get_snapshot(snapshot_id) -> Snapshot + items`
- `export_snapshot(snapshot_id, format=manifest) -> manifest_uri`

### Timeline Query API
- `query_timeline(workspace_id, from, to, filters, cursor) -> events[]`

### Diff API
- `diff_snapshots(snapshot_a_id, snapshot_b_id, options) -> diff_id`

## 5) Политики
- Снимки могут быть:
  - **ephemeral** (перестраиваемые) — для внутренних сравнений
  - **frozen** (зафиксированные) — для аудита, с подписью digest
- Frozen snapshot хранится как immutable manifest + ссылки на WORM события/доказательства.

## 6) Потоки (flows)

### Flow A: Нормализация событий
1) Поступает событие из источника (policy change, evidence added…)
2) Normalizer строит TimelineEvent (canonical)
3) Записывает в Timeline Store + обновляет projections
4) Сохраняет связи worm_ref/offset (если есть)

### Flow B: Построение snapshot (as_of)
1) Пользователь задаёт `as_of`
2) Snapshot Builder читает projections + добирает необходимые события
3) Строит SnapshotItem[] и canonical json
4) Считает digest, сохраняет Snapshot и items_ref
5) (опционально) подписывает digest и сохраняет signed_digest_ref

### Flow C: Diff
1) Пользователь выбирает snapshot A и B
2) Diff Engine строит изменения по control_id
3) Генерирует explainable reasons (ссылки на timeline events)
4) Считает digest diff, сохраняет changes_ref

## 7) Ошибки и повторные попытки
- Projections строятся идемпотентно (по event_id)
- При ошибках normalizer — DLQ, manual reprocess
- Snapshot может быть `partial=true` если часть источников недоступна (фиксируем причины)

## 8) Observability
- Метрики:
  - `timeline_ingest_lag_seconds`
  - `projection_build_errors_total`
  - `snapshot_build_time_ms`
  - `snapshot_partial_total`
- Логи: structured + correlation_id
- Трейсы: span per normalize/build/diff

## 9) Тестирование
- Canonicalization tests (digest стабильность)
- Replay tests (воспроизведение истории из событий)
- Load tests (timeline QPS, snapshot build)
- Security tests (RBAC, auditor read-only)

## 10) Риски
- Сложность canonicalization и стабильности digest
- Стоимость проекций и индексов
- “clock skew” и упорядочивание событий

## 11) План внедрения
- v1: timeline + snapshot manifest + minimal diff
- v2: explainable reasons + frozen snapshots + подписи
- v3: UI timeline (витрины), интеграция с auditor portal (NEXT-17)
