# NEXT-19 — Compliance Timeline & Snapshots

**Block ID:** NEXT-19  
**Название:** Compliance Timeline & Snapshots  
**Дата:** 2026-01-13  
**Статус:** draft

## 1) Назначение
Блок даёт “машину времени” для комплаенса: показывает, **как менялось состояние соответствия во времени**, и умеет строить **снимки (snapshots)** на выбранную дату/период.  

Это нужно, чтобы:
- отвечать аудитору: “покажите состояние контролей на *конкретную дату*”
- сравнивать периоды (Q1 vs Q2) и видеть, **что изменилось**
- автоматически доказывать: “контроль был включён/выключен”, “политика изменилась”, “доказательство обновлено”

## 2) Что входит (артефакты)
Обязательные:
- `README_20260113.md`
- `spec_20260113.md`
- `manifest_20260113.json`
- `checksums_20260113.json`

Опциональные (позже):
- `schema_20260113.json` (схемы Snapshot/Timeline)
- `openapi_20260113.yaml` (API timeline/snapshot/export)
- `pack_files_20260113/…` (скелеты/код)
- `releases/NEXT-19_compliance_timeline_snapshots_pack_20260113.zip` (опционально)

## 3) Входы/выходы
**Входы:**
- Evidence events и WORM лог (NEXT-18)
- события Policy/Config/IAM (policy engine, admin console, connector config)
- результаты оценок/проверок (evaluation/experimentation)
- инциденты/релизы (observability, release workflow)

**Выходы:**
- Timeline (лента событий и изменений) по workspace/org/контролю
- Snapshot (срез состояния) на дату/интервал
- Diff (разница между снимками)
- Экспорт snapshot (manifest для auditor portal)

## 4) Границы и ответственность
**Делает:**
- хранит и индексирует “изменения состояния” (change log) по комплаенсу
- строит снимки из событий и текущих данных
- даёт сравнение snapshot A vs snapshot B (что изменилось, почему)

**Не делает:**
- не собирает raw evidence (collectors)
- не обеспечивает WORM неизменяемость (это NEXT-18)
- не решает доступ аудитора (это NEXT-17)

## 5) Зависимости
- NEXT-18 (WORM log + retention) — источник неизменяемых событий
- Evidence Registry / Report Builder — источники артефактов
- IAM/Workspaces/Orgs — разграничение доступа и контекст
- Search/Vitrines — UI/поиск по истории (опционально)

## 6) UX сценарии (минимум 3)
1) **Аудитор** выбирает дату “2025-12-31” и получает Snapshot + пакет доказательств за период Q4.
2) **Комплаенс** сравнивает “до релиза” и “после релиза” и видит, какие контроли стали red/green и почему.
3) **Безопасник** открывает Timeline контроля “MFA enforced” и видит цепочку: policy change → rollout → evidence updated.

## 7) Данные и схемы (кратко)
- TimelineEvent (нормализованное событие изменения)
- Snapshot (срез состояния комплаенса + ссылки на evidence)
- SnapshotDiff (изменения между снимками)
- Projection (материализованный вид для быстрых запросов)

Подробности — в `spec_20260113.md`.

## 8) Безопасность и комплаенс
- источники истины: WORM-события + подписи/attestations (по мере готовности)
- неизменяемость snapshot: подписанный digest + ссылки на evidence
- доступ: RBAC (auditor read-only, compliance admin)

## 9) Наблюдаемость
- метрики: время построения snapshot, процент “partial”, ошибки проекций
- алерты: отставание проекций, расхождение digest, отсутствие ключевых событий

## 10) План релиза
- P0: timeline index + snapshot builder (без UI, API/CLI)
- P1: diff + explainable reasons (какие события вызвали изменения)
- P2: интеграция с auditor portal, визуальный timeline UI

## 11) TODO / Next
- определить canonical model TimelineEvent (карта источников)
- политика “freeze snapshot” (подпись/attestation)
- оптимизация проекций и быстрых запросов (materialized views)
